<!DOCTYPE html>
<html>
<head>
  <title>Employee Time Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    label, select, input, button { display: block; margin: 10px 0; width: 100%; padding: 8px; }
    #timerDisplay, #breakDisplay { font-size: 1.5em; margin: 10px 0; text-align: center; color: green; }
  </style>
</head>
<body>
  <h2>Employee Time Tracker</h2>
  <label for="name">Name:</label>
  <select id="name">
    <option value="">--Select Name--</option>
    <option>Tarun</option>
    <option>Yuvraj</option>
    <option>Aman</option>
    <option>Art</option>
    <option>Anurag</option>
    <option>PrithviRaj</option>
    <option>Charlie</option>
    <option>Vaishnavi</option>
    <option>Lakshika</option>
    <!-- Add more names here -->
  </select>

  <label for="email">Email:</label>
  <input type="email" id="email" placeholder="Enter email">

  <button id="loginBtn" onclick="login()">Login</button>
  <button id="breakInBtn" onclick="breakIn()">Break In</button>
  <button id="breakOutBtn" onclick="breakOut()">Break Out</button>
  <button id="logoutBtn" onclick="logout()">Logout & Submit</button>
  <button onclick="resetAll()">Reset</button>

  <div id="timerDisplay">Timer: 00:00:00</div>
  <div id="breakDisplay">Breaks: 00:00:00</div>

  <script>
    let loginTime = null, logoutTime = null;
    let timerInterval = null, breakTimer = null;
    let elapsedSeconds = 0, breakSeconds = 0;
    let breaks = [];
    let breakInTimes = [], breakOutTimes = [];

    function getESTTime() { const date = new Date(); const options = { timeZone: 'America/New_York', hour12: false }; // 24-hour format
      const dateString = date.toLocaleString('en-US', options);
      return new Date(dateString).toISOString();
    }

    function formatTime(total) { const hrs = String(Math.floor(total / 3600)).padStart(2, '0'); const mins = String(Math.floor((total % 3600) / 60)).padStart(2, '0'); const secs = String(total % 60).padStart(2, '0'); return `${hrs}:${mins}:${secs}`; }

    function updateDisplay() {
      document.getElementById('timerDisplay').textContent = `Timer: ${formatTime(elapsedSeconds)}`;
      document.getElementById('breakDisplay').textContent = `Breaks: ${formatTime(breakSeconds)}`;
    }

    function saveSession() {
      const sessionData = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        loginTime,
        logoutTime,
        elapsedSeconds,
        breakSeconds,
        breaks,
        breakInTimes,
        breakOutTimes
      };
      localStorage.setItem("employeeSession", JSON.stringify(sessionData));
    }

    function loadSession() {
      const saved = localStorage.getItem("employeeSession");
      if (saved) {
        const data = JSON.parse(saved);
        document.getElementById('name').value = data.name;
        document.getElementById('email').value = data.email;
        loginTime = data.loginTime;
        logoutTime = data.logoutTime;
        elapsedSeconds = data.elapsedSeconds;
        breakSeconds = data.breakSeconds;
        breaks = data.breaks;
        breakInTimes = data.breakInTimes;
        breakOutTimes = data.breakOutTimes;

        if (loginTime && !logoutTime) {
          resumeTimer();
          if (breaks.length > 0 && !breaks[breaks.length - 1].end) resumeBreakTimer();
          disableButtons(['loginBtn']);
        }
        updateDisplay();
      }
    }

    function startTimer() {
      timerInterval = setInterval(() => {
        elapsedSeconds++;
        updateDisplay();
        saveSession();
      }, 1000);
    }

    function resumeTimer() {
      const now = new Date();
      const login = new Date(loginTime);
      elapsedSeconds = Math.floor((now - login) / 1000);
      startTimer();
    }

    function stopTimer() { clearInterval(timerInterval); }

    function startBreakTimer() {
      breakTimer = setInterval(() => {
        breakSeconds++;
        updateDisplay();
        saveSession();
      }, 1000);
    }

    function resumeBreakTimer() { startBreakTimer(); }
    function stopBreakTimer() { clearInterval(breakTimer); }

    function login() {
      loginTime = getESTTime();
      elapsedSeconds = 0;
      breakSeconds = 0;
      breaks = [];
      breakInTimes = [];
      breakOutTimes = [];
      startTimer();
      disableButtons(['loginBtn']);
      saveSession();
      alert("Login recorded at: " + loginTime);
    }

    function breakIn() {
      const time = getESTTime();
      breaks.push({ start: time, end: null });
      breakInTimes.push(time);
      startBreakTimer();
      disableButtons(['breakInBtn']);
      saveSession();
      alert("Break started.");
    }

    function breakOut() {
      if (breaks.length > 0 && !breaks[breaks.length - 1].end) {
        const time = getESTTime();
        breaks[breaks.length - 1].end = time;
        breakOutTimes.push(time);
        stopBreakTimer();
        disableButtons(['breakOutBtn'], false);
        disableButtons(['breakInBtn'], false);
        saveSession();
        alert("Break ended.");
      }
    }

    function logout() {
      logoutTime = getESTTime();
      stopTimer();
      stopBreakTimer();

      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;

      if (!name || !email || !loginTime || !logoutTime) {
        alert("Please complete login/logout and fill all fields.");
        return;
      }

      const formData = {
        name,
        email,
        loginTime,
        logoutTime,
        breakDetails: breaks,
        breakInTimes,
        breakOutTimes,
        totalDuration: formatTime(elapsedSeconds),
        breakDuration: formatTime(breakSeconds),
        workDuration: formatTime(elapsedSeconds - breakSeconds)
      };

      fetch("https://script.google.com/macros/s/AKfycbzEdniBWPYGRj8-0Fhdhf5fuGdDw1JF5NzAXDIO61IHFOty9360m0QDcvRSNO059Om6Ag/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
      });

      localStorage.removeItem("employeeSession");
      alert("Data submitted successfully!");
      disableButtons(['logoutBtn', 'breakInBtn', 'breakOutBtn']);
    }

    function resetAll() {
      stopTimer();
      stopBreakTimer();
      loginTime = logoutTime = null;
      elapsedSeconds = breakSeconds = 0;
      breaks = [];
      breakInTimes = [];
      breakOutTimes = [];
      updateDisplay();
      disableButtons(['loginBtn', 'breakInBtn', 'breakOutBtn', 'logoutBtn'], false);
      localStorage.removeItem("employeeSession");
      alert("Form reset.");
    }

    function disableButtons(ids, state = true) {
      ids.forEach(id => document.getElementById(id).disabled = state);
    }

    window.addEventListener("beforeunload", function (e) { if (loginTime && !logoutTime) { e.preventDefault(); e.returnValue = ''; }});

    window.onload = loadSession;
  </script>
</body>
</html>
